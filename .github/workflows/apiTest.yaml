name: Automated API tests using Postman CLI

on: push

jobs:
  automated-api-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Docker
      uses: docker/setup-buildx-action@v1

    - name: Build and run Docker Compose
      run: |
        docker-compose up -d
  
    - name: Get backend container IP
      id: backend_ip
      run: |
        echo "::set-output name=ip::$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' backend)"
        
    - name: Install Postman CLI
      run: |
        curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
        
    - name: Login to Postman CLI
      run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
      
    - name: Run API tests
      run: |
        postman collection run "${{ github.workspace }}/postman/collections/tests.json" -e "20887326-37b84bc2-f993-415e-b8b0-c72f2e85e26e" --integration-id "138020-${{ github.run_id }}" --env-var "baseUrl=http://${{ steps.backend_ip.outputs.ip }}:5000"

    - name: Stop and remove Docker Compose services
      run: |
        docker-compose down

